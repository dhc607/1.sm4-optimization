# SM4优化方法说明

## 1. 优化概述

为提高SM4算法的执行效率，本项目实现了多种优化方法。这些优化主要针对算法的核心计算部分，通过减少计算复杂度或利用现代计算机体系结构的特性来提高性能。

## 2. T-table优化

T-table优化是分组密码中常用的优化技术，通过预计算核心变换的结果来减少实际加密/解密过程中的计算量。

### 2.1 原理

SM4算法中的T函数是最耗时的操作之一，它由S盒替换（非线性变换）和线性变换组成。T-table优化通过预先计算所有可能输入的T函数结果，将复杂的计算转换为简单的查表操作。

对于SM4，我们预计算4个256项的表（T_table[0]到T_table[3]），分别对应输入的4个字节位置（高位到低位）。每个表项存储对应字节值经过S盒替换和线性变换后的完整32位结果。

### 2.2 实现

预计算过程：for i in range(256):
    s = Sbox[i]  # S盒替换
    # 计算每个位置的线性变换结果并存储
    T_table[0][i] = (s << 24) ^ rotate_left(s << 24, 2) ^ ...
    T_table[1][i] = (s << 16) ^ rotate_left(s << 16, 2) ^ ...
    # ... 以此类推
使用时，只需将输入分解为4个字节，分别查表后异或即可：def T(x):
    x0 = (x >> 24) & 0xFF
    x1 = (x >> 16) & 0xFF
    x2 = (x >> 8) & 0xFF
    x3 = x & 0xFF
    return T_table[0][x0] ^ T_table[1][x1] ^ T_table[2][x2] ^ T_table[3][x3]
### 2.3 效果

T-table优化将T函数的计算从多次位运算和S盒查找简化为4次查表和3次异或操作，通常能带来2-3倍的性能提升。

## 3. 向量化优化

向量化优化利用现代CPU的SIMD（单指令多数据）指令，通过一次操作处理多个数据元素，提高并行计算能力。

### 3.1 原理

向量化优化通过将多个独立的加密操作打包成向量操作，充分利用CPU的向量处理单元。在Python中，我们可以使用NumPy库来实现向量化操作。

### 3.2 实现

向量化优化将关键数据结构（如T-table和轮密钥）转换为NumPy数组，并使用NumPy的向量化操作替代循环操作：
# 将T_table转换为numpy数组
self.T_table_np = np.array(self.T_table, dtype=np.uint32)

# 使用向量化操作进行加密
x = X[1] ^ X[2] ^ X[3] ^ self.round_keys_np[i]
x0 = (x >> 24) & 0xFF
x1 = (x >> 16) & 0xFF
x2 = (x >> 8) & 0xFF
x3 = x & 0xFF

t_val = self.T_table_np[0, x0] ^ self.T_table_np[1, x1] ^ 
        self.T_table_np[2, x2] ^ self.T_table_np[3, x3]
### 3.3 效果

向量化优化能够有效利用CPU的并行处理能力，对于批量数据处理，通常能在T-table优化的基础上再提升1.5-2倍的性能。

## 4. 其他潜在优化

### 4.1 AESNI指令集优化

AESNI（Advanced Encryption Standard New Instructions）是Intel推出的针对AES加密算法的硬件加速指令集。虽然它主要针对AES，但也可以通过一些技巧用于加速SM4算法：

1. 使用`AESENC`指令模拟SM4的轮函数
2. 利用`PSHUFB`指令加速S盒查找
3. 使用`PXOR`和循环移位指令实现线性变换

这种优化需要使用汇编语言或特定的编译器内在函数，在纯Python中难以实现，但可以通过C扩展模块来利用这些指令。

### 4.2 GFNI指令集优化

GFNI（Galois Field New Instructions）是Intel在第10代酷睿处理器中引入的新指令集，专门用于伽罗瓦域运算，非常适合加速GCM模式中的GHASH计算：

1. `GF2P8AFFINEQB`：用于实现伽罗瓦域上的仿射变换，可加速S盒操作
2. `GF2P8MULB`：用于伽罗瓦域上的乘法，可显著加速GHASH中的多项式乘法

与AESNI类似，GFNI优化也需要底层语言支持，但能为GCM模式带来显著的性能提升。

### 4.3 VPROLD指令优化

VPROLD（Vector Permute Doubleword）指令用于向量中的双字置换，可用于优化SM4中的字节替换和移位操作，进一步提高并行处理效率。

## 5. 优化效果对比

在标准x86架构处理器上，各种优化的性能提升大致如下：

| 实现方式 | 相对性能 | 说明 |
|---------|---------|------|
| 基本实现 | 1x | 无优化 |
| T-table优化 | 2-3x | 预计算T函数结果 |
| 向量化优化 | 3-6x | 基于T-table优化，使用NumPy |
| AESNI优化 | 8-12x | 需要硬件支持和C扩展 |
| GFNI优化 | 对于GCM模式额外提升2-3x | 需要硬件支持和C扩展 |

注：实际性能提升可能因硬件环境和数据规模而有所不同。

