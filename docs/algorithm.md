# SM4算法说明

## 1. 算法概述

SM4是一种分组密码算法，由中国国家密码管理局发布，标准号为GB/T 32907-2016。它主要用于无线局域网等领域的加密保护。

SM4算法的特点：
- 分组长度：128位
- 密钥长度：128位
- 迭代轮数：32轮
- 结构：Feistel结构

## 2. 数学描述

### 2.1 基本符号

- 明文和密文：128位，记为$P$和$C$
- 密钥：128位，记为$MK$
- 轮密钥：共32个，记为$RK_0, RK_1, ..., RK_{31}$
- 中间状态：每轮迭代的128位状态，记为$X_0, X_1, ..., X_{32}$

### 2.2 加密过程

加密过程可以表示为：

$$C = SM4\_Encrypt(P, MK)$$

具体步骤：

1. 密钥扩展：由128位主密钥$MK$生成32个32位轮密钥$RK_i$
2. 初始变换：将明文$P$分为4个32位字$X_0, X_1, X_2, X_3$
3. 32轮迭代：
   $$X_{i+4} = X_i \oplus T(X_{i+1} \oplus X_{i+2} \oplus X_{i+3} \oplus RK_i)$$
   其中$T$是一个非线性变换函数
4. 反序变换：$C = (X_{35}, X_{34}, X_{33}, X_{32})$

### 2.3 解密过程

解密过程与加密过程结构相同，但轮密钥的使用顺序相反：

$$P = SM4\_Decrypt(C, MK)$$

解密使用轮密钥顺序为$RK_{31}, RK_{30}, ..., RK_0$

## 3. 核心函数

### 3.1 T函数

T函数是SM4算法的核心，由非线性变换$\tau$和线性变换$L$组成：

$$T(X) = L(\tau(X))$$

#### 3.1.1 非线性变换$\tau$

$\tau$是一个字节替换变换，使用S盒对输入的4个字节分别进行替换：

$$\tau(X) = (S(X_0), S(X_1), S(X_2), S(X_3))$$

其中$X = (X_0, X_1, X_2, X_3)$，每个$X_i$是8位字节，$S$是S盒替换函数。

#### 3.1.2 线性变换$L$

线性变换$L$定义为：

$$L(b) = b \oplus (b \ll 2) \oplus (b \ll 10) \oplus (b \ll 18) \oplus (b \ll 24)$$

其中$\ll$表示循环左移操作。

### 3.2 密钥扩展

密钥扩展算法用于从主密钥生成32个轮密钥：

1. 初始变换：将主密钥$MK$分为4个32位字$K_0, K_1, K_2, K_3$
2. 与系统参数$FK$异或：
   $$K_i' = K_i \oplus FK_i, \quad i=0,1,2,3$$
3. 生成轮密钥：
   $$RK_i = K_{i+4}' = K_i' \oplus T'(K_{i+1}' \oplus K_{i+2}' \oplus K_{i+3}' \oplus CK_i)$$
   其中$T'$是密钥扩展中的非线性变换，$CK_i$是固定参数。

$T'$函数与$T$函数类似，但线性变换$L'$不同：

$$L'(b) = b \oplus (b \ll 13) \oplus (b \ll 23)$$

## 4. S盒

SM4使用固定的8x8 S盒，用于实现非线性变换。S盒的设计考虑了安全性和实现效率，具有良好的非线性特性和抗差分攻击能力。

S盒的具体数值参见代码实现中的`self.Sbox`数组。

## 5. 系统参数和固定参数

- 系统参数$FK$：
  $$FK = [0xA3B1BAC6, 0x56AA3350, 0x677D9197, 0xB27022DC]$$

- 固定参数$CK$：共32个，具体数值参见代码实现。

